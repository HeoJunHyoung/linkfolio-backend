# 5_COMMUNITY_SERVICE.md

## 1. 개요

`community-service`는 개발자 생태계 활성화를 위한 **게시판 및 팀원 모집** 기능을 담당한다.

계층형 댓글(Nested Comments) 구조와 답변 채택 로직 등 복잡한 도메인 로직을 포함하며, 팀원 모집 시 `chat-service`와 연동하여 실시간 소통을 지원하는 등 서비스 간 오케스트레이션이 활발한 모듈이다.

---

## 2. 핵심 기능

* **게시글 유형별 로직 분리**:
    * **자유(FREE)**: 일반적인 CRUD.
    * **질문(QNA)**: 답변 채택 기능(`isSolved`), 채택 시 상태 변경 로직 포함.
    * **채용(RECRUIT)**: 모집 상태(`OPEN`/`CLOSED`) 관리 및 채팅 연동 지원.
* **계층형 댓글**: 부모-자식 관계(`parentId`)를 가진 무한 대댓글 구조 지원 및 조회 시 트리 구조 변환.
* **팀원 모집 연동**: 지원하기 버튼 클릭 시 채팅방 생성 및 메시지 자동 발송.

---

## 3. 캐싱 및 데이터 처리 전략

`PortfolioService`와 유사한 캐싱 구조를 가지지만, **댓글(Comment)**의 특수성으로 인해 전략이 일부 수정되었다.

### 3.1. 부분 캐싱 전략 (Partial Caching)

게시글 상세 조회(`getPostDetail`) 시 전체를 캐싱하지 않는다.

* **게시글 본문 (`post:info:{id}`)**: 캐싱 대상 **(O)**. 수정 빈도가 낮음.
* **통계 정보 (`post:stats:{id}`)**: 캐싱 대상 **(O)**. Redis Write-Back 대상.
* **댓글 목록**: 캐싱 대상 **(X)**.
    * **이유**: 댓글은 작성/수정/삭제가 매우 빈번하며, 특정 댓글 하나가 변경되어도 전체 리스트 캐시를 갱신해야 하는 비용이 큼.
    * **구현**: 댓글은 항상 DB에서 조회(`findCommentsByPostId`) 후, 애플리케이션 레벨에서 부모-자식 트리 구조로 조립(`convertToCommentHierarchy`)한다.

### 3.2. Q&A 답변 채택 로직

1.  작성자가 특정 댓글에 대해 채택 요청을 보낸다.
2.  **검증**: 게시글 작성자 본인인지, 이미 채택된 글인지 확인한다.
3.  **상태 변경 (Atomicity)**:
    * 해당 댓글(`PostCommentEntity`): `accepted = true`
    * 게시글(`PostEntity`): `isSolved = true`
4.  **캐시 무효화**: 게시글의 상태가 변경되었으므로 `post:info:{id}`를 삭제하여 갱신을 유도한다.

---

## 4. 외부 서비스 연동 (채용 프로세스)

팀원 모집 게시글에서 '지원하기' 기능은 `chat-service`와의 동기 통신을 통해 이루어진다.

1.  **API 호출**: 사용자가 `applyTeam(postId)`를 호출한다.
2.  **유효성 검증**: 모집 중(`OPEN`) 상태인지 확인한다.
3.  **Feign Client**: `chatServiceClient.sendMessageInternal()`을 호출한다.
    * **Payload**: 지원자 ID, 게시글 작성자 ID, "OOO 게시글을 보고 지원합니다." (자동 생성 메시지)
4.  **Chat Service 처리**: 두 사용자 간의 채팅방이 없으면 생성하고, 있으면 기존 방을 불러와 메시지를 저장 및 전송한다.
5.  **결과 반환**: 별도의 지원 현황 테이블 없이, 채팅방 생성을 지원 완료로 간주한다.